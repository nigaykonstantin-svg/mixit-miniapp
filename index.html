<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MIXIT Creators</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2678b6;
            --tg-theme-button-color: #FF6B9D;
            --tg-theme-button-text-color: #ffffff;
        }
        
        body {
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding-bottom: 100px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FF6B9D 0%, #FF8A80 100%);
            color: white;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .badge-hit { background: linear-gradient(135deg, #FF6B9D, #FF8A80); }
        .badge-new { background: linear-gradient(135deg, #4CAF50, #66BB6A); }
        
        .level-bronze { background: #CD7F32; }
        .level-silver { background: #C0C0C0; }
        .level-gold { background: #FFD700; }
        .level-platinum { background: #E5E4E2; }
        .level-diamond { background: linear-gradient(135deg, #B9F2FF, #89CFF0); }
        
        .product-card.selected {
            ring: 2px solid #FF6B9D;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.3);
        }
        
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #eee;
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        
        .tab-active {
            color: #FF6B9D;
            border-bottom: 2px solid #FF6B9D;
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Telegram WebApp API
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation();
        }
        
        // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const telegramUser = tg?.initDataUnsafe?.user || {
            id: 123456789,
            first_name: '–¢–µ—Å—Ç',
            last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            username: 'test_user'
        };

        // ==================== DATA ====================
        
        const PRODUCTS = [
            { id: 1, name: 'Skin Chemistry Serum', category: '–õ–∏—Ü–æ', volume: '30 ml', desc: '–°—ã–≤–æ—Ä–æ—Ç–∫–∞ —Å –≥–∏–∞–ª—É—Ä–æ–Ω–æ–≤–æ–π –∫–∏—Å–ª–æ—Ç–æ–π', rating: 4.9, badge: 'HIT', image: 'üß¥', color: '#FFB5C5' },
            { id: 2, name: 'Coco Sulfate Free', category: '–í–æ–ª–æ—Å—ã', volume: '250 ml', desc: '–ë–µ—Å—Å—É–ª—å—Ñ–∞—Ç–Ω—ã–π —à–∞–º–ø—É–Ω—å —Å –∫–æ–∫–æ—Å–æ–≤—ã–º –º–∞—Å–ª–æ–º', rating: 4.8, badge: 'NEW', image: 'üß¥', color: '#87CEEB' },
            { id: 3, name: 'Coffee Body Scrub', category: '–¢–µ–ª–æ', volume: '200 g', desc: '–ö–æ—Ñ–µ–π–Ω—ã–π —Å–∫—Ä–∞–± –¥–ª—è —Ç–µ–ª–∞', rating: 5.0, badge: null, image: '‚òï', color: '#DEB887' },
            { id: 4, name: 'Matte Lipstick Rose', category: '–ú–∞–∫–∏—è–∂', volume: '4 g', desc: '–ú–∞—Ç–æ–≤–∞—è –ø–æ–º–∞–¥–∞ —Ä–æ–∑–æ–≤–æ–≥–æ –æ—Ç—Ç–µ–Ω–∫–∞', rating: 4.7, badge: 'HIT', image: 'üíÑ', color: '#FF6B9D' },
            { id: 5, name: 'Hydra Face Cream', category: '–õ–∏—Ü–æ', volume: '50 ml', desc: '–£–≤–ª–∞–∂–Ω—è—é—â–∏–π –∫—Ä–µ–º –¥–ª—è –ª–∏—Ü–∞', rating: 4.6, badge: null, image: '‚ú®', color: '#E6E6FA' },
            { id: 6, name: 'Keratin Hair Mask', category: '–í–æ–ª–æ—Å—ã', volume: '300 ml', desc: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∞—è –º–∞—Å–∫–∞ —Å –∫–µ—Ä–∞—Ç–∏–Ω–æ–º', rating: 4.9, badge: 'NEW', image: 'üíÜ', color: '#98FB98' },
            { id: 7, name: 'Shea Body Butter', category: '–¢–µ–ª–æ', volume: '150 ml', desc: '–ü–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ —à–∏ –¥–ª—è —Ç–µ–ª–∞', rating: 4.8, badge: null, image: 'üßà', color: '#FFEFD5' },
            { id: 8, name: 'Eyeshadow Palette', category: '–ú–∞–∫–∏—è–∂', volume: '12 colors', desc: '–ü–∞–ª–µ—Ç–∫–∞ —Ç–µ–Ω–µ–π –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã—Ö –æ—Ç—Ç–µ–Ω–∫–æ–≤', rating: 4.9, badge: 'HIT', image: 'üé®', color: '#D2691E' },
        ];
        
        const LEVELS = [
            { name: '–ù–∞—á–∏–Ω–∞—é—â–∏–π', min: 1000, max: 10000, minER: 3, color: '#CD7F32', products: [2, 4], emoji: 'ü•â' },
            { name: '–ü–æ–¥–∞—é—â–∏–π –Ω–∞–¥–µ–∂–¥—ã', min: 10000, max: 50000, minER: 4, color: '#C0C0C0', products: [3, 5], emoji: 'ü•à' },
            { name: '–û–ø—ã—Ç–Ω—ã–π', min: 50000, max: 150000, minER: 3.5, color: '#FFD700', products: [4, 6], emoji: 'ü•á' },
            { name: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π', min: 150000, max: 500000, minER: 3, color: '#E5E4E2', products: [6, 8], emoji: 'üíé' },
            { name: '–ó–≤–µ–∑–¥–∞', min: 500000, max: 999999999, minER: 2.5, color: '#B9F2FF', products: [8, 12], emoji: '‚≠ê' },
        ];

        // ==================== STATE ====================
        
        let state = {
            currentTab: 'catalog',
            selectedProducts: [],
            category: '–í—Å–µ',
            user: {
                id: telegramUser.id,
                name: telegramUser.first_name + ' ' + (telegramUser.last_name || ''),
                username: '@' + (telegramUser.username || 'user'),
                registered: false,
                status: 'new', // new | pending | approved
                levelIndex: 0,
                points: 0,
                followers: 0,
                er: 0,
            },
            delivery: {
                name: '',
                phone: '',
                address: '',
            },
            step: 'catalog', // catalog | cart | delivery | success
            collabs: [],
        };
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const saved = localStorage.getItem('mixit_state');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed, selectedProducts: parsed.selectedProducts || [] };
            } catch (e) {}
        }
        
        function saveState() {
            localStorage.setItem('mixit_state', JSON.stringify(state));
        }

        // ==================== RENDER ====================
        
        function render() {
            const app = document.getElementById('app');
            
            if (!state.user.registered) {
                app.innerHTML = renderRegistration();
            } else if (state.user.status === 'pending') {
                app.innerHTML = renderPending();
            } else if (state.user.status === 'approved') {
                app.innerHTML = renderMain();
            } else {
                app.innerHTML = renderRegistration();
            }
            
            saveState();
        }
        
        // ==================== REGISTRATION ====================
        
        function renderRegistration() {
            return `
                <div class="min-h-screen flex flex-col p-4">
                    <div class="text-center mb-8 mt-8">
                        <div class="w-20 h-20 bg-gradient-to-br from-pink-500 to-rose-500 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4 shadow-lg">
                            ‚ú®
                        </div>
                        <h1 class="text-2xl font-bold mb-2">MIXIT Creators</h1>
                        <p class="text-gray-500">–°—Ç–∞–Ω—å—Ç–µ —á–∞—Å—Ç—å—é –∫–æ–º–∞–Ω–¥—ã</p>
                    </div>
                    
                    <div class="card p-4 mb-4 slide-up">
                        <h2 class="font-semibold mb-4">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
                        
                        <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-xl">
                            <div class="w-12 h-12 bg-gradient-to-br from-pink-100 to-rose-100 rounded-full flex items-center justify-center text-2xl">
                                üë§
                            </div>
                            <div>
                                <p class="font-medium">${state.user.name}</p>
                                <p class="text-sm text-gray-500">${state.user.username}</p>
                            </div>
                            <span class="ml-auto text-green-500 text-sm">‚úì Telegram</span>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">Instagram *</label>
                                <input 
                                    type="text" 
                                    id="instagram"
                                    placeholder="@–≤–∞—à_–∞–∫–∫–∞—É–Ω—Ç"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500"
                                >
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-sm text-gray-500 mb-1 block">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</label>
                                    <input 
                                        type="number" 
                                        id="followers"
                                        placeholder="15000"
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500"
                                    >
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500 mb-1 block">ER %</label>
                                    <input 
                                        type="number" 
                                        id="er"
                                        placeholder="4.5"
                                        step="0.1"
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500"
                                    >
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">–ù–∏—à–∞</label>
                                <select 
                                    id="niche"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white"
                                >
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∏—à—É</option>
                                    <option value="beauty">Beauty</option>
                                    <option value="skincare">Skincare</option>
                                    <option value="lifestyle">Lifestyle</option>
                                    <option value="fashion">Fashion</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-4 mb-4 slide-up" style="animation-delay: 0.1s">
                        <h3 class="font-semibold mb-3">–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:</h3>
                        <ul class="space-y-2 text-sm">
                            <li class="flex items-center gap-2">
                                <span class="text-pink-500">‚úì</span>
                                –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –æ–±–∑–æ—Ä–æ–≤
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-pink-500">‚úì</span>
                                –†–æ—Å—Ç —É—Ä–æ–≤–Ω—è –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-pink-500">‚úì</span>
                                –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ç–æ–ø–æ–≤
                            </li>
                        </ul>
                    </div>
                    
                    <button 
                        onclick="submitRegistration()"
                        class="w-full btn-primary py-4 rounded-xl font-semibold text-lg shadow-lg"
                    >
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                </div>
            `;
        }
        
        function submitRegistration() {
            const instagram = document.getElementById('instagram').value;
            const followers = parseInt(document.getElementById('followers').value) || 0;
            const er = parseFloat(document.getElementById('er').value) || 0;
            const niche = document.getElementById('niche').value;
            
            if (!instagram || !followers || !er || !niche) {
                tg?.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
            let levelIndex = 0;
            for (let i = LEVELS.length - 1; i >= 0; i--) {
                if (followers >= LEVELS[i].min && er >= LEVELS[i].minER) {
                    levelIndex = i;
                    break;
                }
            }
            
            state.user = {
                ...state.user,
                instagram,
                followers,
                er,
                niche,
                levelIndex,
                registered: true,
                status: 'pending',
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç
            if (tg) {
                tg.sendData(JSON.stringify({
                    action: 'register',
                    user: state.user
                }));
            }
            
            render();
        }
        
        // ==================== PENDING ====================
        
        function renderPending() {
            return `
                <div class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
                    <div class="w-24 h-24 bg-amber-100 rounded-full flex items-center justify-center text-5xl mb-6 animate-pulse">
                        ‚è≥
                    </div>
                    <h1 class="text-2xl font-bold mb-2">–ó–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h1>
                    <p class="text-gray-500 mb-6">–ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç. –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 24 —á–∞—Å–æ–≤.</p>
                    
                    <div class="card p-4 w-full max-w-sm">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-500">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</span>
                            <span class="font-semibold">${formatNumber(state.user.followers)}</span>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-500">ER</span>
                            <span class="font-semibold text-green-500">${state.user.er}%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-500">–£—Ä–æ–≤–µ–Ω—å</span>
                            <span class="font-semibold">${LEVELS[state.user.levelIndex].emoji} ${LEVELS[state.user.levelIndex].name}</span>
                        </div>
                    </div>
                    
                    <button 
                        onclick="simulateApproval()"
                        class="mt-6 text-pink-500 underline text-sm"
                    >
                        (–î–µ–º–æ: —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ)
                    </button>
                </div>
            `;
        }
        
        function simulateApproval() {
            state.user.status = 'approved';
            state.user.points = 0;
            render();
            tg?.showAlert('–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞! üéâ');
        }
        
        // ==================== MAIN APP ====================
        
        function renderMain() {
            let content = '';
            
            switch (state.step) {
                case 'catalog':
                    content = renderCatalog();
                    break;
                case 'cart':
                    content = renderCart();
                    break;
                case 'delivery':
                    content = renderDelivery();
                    break;
                case 'success':
                    content = renderSuccess();
                    break;
            }
            
            return `
                ${renderHeader()}
                ${content}
                ${state.step === 'catalog' ? renderBottomNav() : ''}
            `;
        }
        
        function renderHeader() {
            const level = LEVELS[state.user.levelIndex];
            return `
                <div class="bg-white p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" 
                             style="background: ${level.color}20">
                            ${level.emoji}
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold">${state.user.name}</p>
                            <p class="text-xs text-gray-500">${level.name} ‚Ä¢ ${state.user.points} –æ—á–∫–æ–≤</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å</p>
                            <p class="font-bold text-pink-500">${level.products[0]}-${level.products[1]} –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCatalog() {
            const categories = ['–í—Å–µ', '–õ–∏—Ü–æ', '–í–æ–ª–æ—Å—ã', '–¢–µ–ª–æ', '–ú–∞–∫–∏—è–∂'];
            const filtered = state.category === '–í—Å–µ' 
                ? PRODUCTS 
                : PRODUCTS.filter(p => p.category === state.category);
            
            const level = LEVELS[state.user.levelIndex];
            const maxProducts = level.products[1];
            
            return `
                <div class="p-4">
                    <h2 class="text-xl font-bold mb-1">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h2>
                    <p class="text-gray-500 text-sm mb-4">
                        –í—ã–±—Ä–∞–Ω–æ: <span class="font-semibold text-pink-500">${state.selectedProducts.length}</span> / ${maxProducts}
                    </p>
                    
                    <div class="flex gap-2 overflow-x-auto pb-3 mb-4 -mx-4 px-4">
                        ${categories.map(cat => `
                            <button 
                                onclick="setCategory('${cat}')"
                                class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all
                                    ${state.category === cat 
                                        ? 'bg-pink-500 text-white' 
                                        : 'bg-white text-gray-600 border border-gray-200'}"
                            >
                                ${cat}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        ${filtered.map(product => renderProductCard(product)).join('')}
                    </div>
                </div>
                
                ${state.selectedProducts.length >= level.products[0] ? `
                    <div class="bottom-bar">
                        <button 
                            onclick="goToCart()"
                            class="w-full btn-primary py-4 rounded-xl font-semibold flex items-center justify-center gap-2"
                        >
                            <span>–û—Ñ–æ—Ä–º–∏—Ç—å –±–æ–∫—Å</span>
                            <span class="bg-white/20 px-2 py-0.5 rounded-full text-sm">${state.selectedProducts.length}</span>
                        </button>
                    </div>
                ` : ''}
            `;
        }
        
        function renderProductCard(product) {
            const isSelected = state.selectedProducts.includes(product.id);
            const level = LEVELS[state.user.levelIndex];
            const canSelect = state.selectedProducts.length < level.products[1] || isSelected;
            
            return `
                <div 
                    onclick="${canSelect ? `toggleProduct(${product.id})` : ''}"
                    class="card overflow-hidden transition-all ${isSelected ? 'ring-2 ring-pink-500' : ''} ${!canSelect ? 'opacity-50' : ''}"
                >
                    ${product.badge ? `
                        <div class="absolute top-2 left-2 z-10">
                            <span class="px-2 py-0.5 text-[10px] font-bold text-white rounded-full ${product.badge === 'HIT' ? 'badge-hit' : 'badge-new'}">
                                ${product.badge}
                            </span>
                        </div>
                    ` : ''}
                    
                    <div class="h-28 flex items-center justify-center text-4xl relative" style="background: ${product.color}30">
                        ${product.image}
                        ${isSelected ? `
                            <div class="absolute inset-0 bg-pink-500/20 flex items-center justify-center">
                                <div class="w-8 h-8 bg-pink-500 rounded-full flex items-center justify-center text-white text-lg">‚úì</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="p-3">
                        <h3 class="font-semibold text-sm mb-1 line-clamp-1">${product.name}</h3>
                        <p class="text-xs text-gray-500 mb-2">${product.volume} ‚Ä¢ ${product.category}</p>
                        <div class="flex items-center gap-1">
                            <span class="text-amber-400 text-sm">‚òÖ</span>
                            <span class="text-sm font-medium">${product.rating}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCart() {
            const selectedProducts = PRODUCTS.filter(p => state.selectedProducts.includes(p.id));
            
            return `
                <div class="p-4">
                    <button onclick="goBack()" class="flex items-center gap-2 text-gray-500 mb-4">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    
                    <h2 class="text-xl font-bold mb-4">–í–∞—à –±–æ–∫—Å</h2>
                    
                    <div class="space-y-3 mb-6">
                        ${selectedProducts.map(product => `
                            <div class="card p-3 flex items-center gap-3">
                                <div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl" style="background: ${product.color}30">
                                    ${product.image}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-sm">${product.name}</h3>
                                    <p class="text-xs text-gray-500">${product.volume}</p>
                                </div>
                                <button onclick="toggleProduct(${product.id})" class="text-gray-400 p-2">‚úï</button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button 
                        onclick="goToDelivery()"
                        class="w-full btn-primary py-4 rounded-xl font-semibold"
                    >
                        –î–∞–ª–µ–µ ‚Äî –î–æ—Å—Ç–∞–≤–∫–∞
                    </button>
                </div>
            `;
        }
        
        function renderDelivery() {
            return `
                <div class="p-4">
                    <button onclick="state.step = 'cart'; render();" class="flex items-center gap-2 text-gray-500 mb-4">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    
                    <h2 class="text-xl font-bold mb-4">–î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
                    
                    <div class="space-y-3 mb-6">
                        <input 
                            type="text" 
                            id="deliveryName"
                            placeholder="–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è"
                            value="${state.delivery.name}"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500"
                        >
                        <input 
                            type="tel" 
                            id="deliveryPhone"
                            placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"
                            value="${state.delivery.phone}"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500"
                        >
                        <textarea 
                            id="deliveryAddress"
                            placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ —Å –∏–Ω–¥–µ–∫—Å–æ–º"
                            rows="3"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-500 resize-none"
                        >${state.delivery.address}</textarea>
                    </div>
                    
                    <div class="card p-4 mb-6 bg-amber-50 border border-amber-200">
                        <p class="text-amber-800 font-medium text-sm">‚è∞ –°—Ä–æ–∫ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç: 14 –¥–Ω–µ–π</p>
                        <p class="text-amber-600 text-xs mt-1">–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–∫—Å–∞</p>
                    </div>
                    
                    <button 
                        onclick="submitOrder()"
                        class="w-full btn-primary py-4 rounded-xl font-semibold"
                    >
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—é
                    </button>
                </div>
            `;
        }
        
        function renderSuccess() {
            return `
                <div class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-5xl mb-6">
                        ‚úì
                    </div>
                    <h1 class="text-2xl font-bold mb-2">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h1>
                    <p class="text-gray-500 mb-6">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –±–æ–∫—Å –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.</p>
                    
                    <button 
                        onclick="resetOrder()"
                        class="btn-primary px-8 py-3 rounded-xl font-semibold"
                    >
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥
                    </button>
                </div>
            `;
        }
        
        function renderBottomNav() {
            const tabs = [
                { id: 'catalog', icon: 'üõçÔ∏è', label: '–ö–∞—Ç–∞–ª–æ–≥' },
                { id: 'collabs', icon: 'üì¶', label: '–ö–æ–ª–ª–∞–±—ã' },
                { id: 'rating', icon: 'üèÜ', label: '–†–µ–π—Ç–∏–Ω–≥' },
                { id: 'profile', icon: 'üë§', label: '–ü—Ä–æ—Ñ–∏–ª—å' },
            ];
            
            return `
                <div class="bottom-bar flex justify-around pt-2" style="padding-bottom: max(8px, env(safe-area-inset-bottom))">
                    ${tabs.map(tab => `
                        <button 
                            onclick="setTab('${tab.id}')"
                            class="flex flex-col items-center gap-1 px-4 py-2 ${state.currentTab === tab.id ? 'text-pink-500' : 'text-gray-400'}"
                        >
                            <span class="text-xl">${tab.icon}</span>
                            <span class="text-xs">${tab.label}</span>
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // ==================== ACTIONS ====================
        
        function setCategory(cat) {
            state.category = cat;
            render();
        }
        
        function toggleProduct(id) {
            const level = LEVELS[state.user.levelIndex];
            
            if (state.selectedProducts.includes(id)) {
                state.selectedProducts = state.selectedProducts.filter(x => x !== id);
            } else if (state.selectedProducts.length < level.products[1]) {
                state.selectedProducts.push(id);
                tg?.HapticFeedback?.impactOccurred('light');
            }
            render();
        }
        
        function goToCart() {
            state.step = 'cart';
            render();
        }
        
        function goToDelivery() {
            state.step = 'delivery';
            render();
        }
        
        function goBack() {
            state.step = 'catalog';
            render();
        }
        
        function submitOrder() {
            const name = document.getElementById('deliveryName').value;
            const phone = document.getElementById('deliveryPhone').value;
            const address = document.getElementById('deliveryAddress').value;
            
            if (!name || !phone || !address) {
                tg?.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏');
                return;
            }
            
            state.delivery = { name, phone, address };
            
            const order = {
                action: 'new_order',
                user: state.user,
                products: state.selectedProducts.map(id => PRODUCTS.find(p => p.id === id)),
                delivery: state.delivery,
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç
            if (tg) {
                tg.sendData(JSON.stringify(order));
            }
            
            state.step = 'success';
            render();
            tg?.HapticFeedback?.notificationOccurred('success');
        }
        
        function resetOrder() {
            state.selectedProducts = [];
            state.step = 'catalog';
            render();
        }
        
        function setTab(tab) {
            state.currentTab = tab;
            if (tab === 'catalog') {
                state.step = 'catalog';
            }
            render();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∞–±–æ–≤
            if (tab !== 'catalog') {
                tg?.showAlert('–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è');
            }
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // ==================== INIT ====================
        
        render();
    </script>
</body>
</html>
